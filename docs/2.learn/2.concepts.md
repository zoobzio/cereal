---
title: Concepts
description: Core concepts and design principles
author: zoobzio
published: 2025-12-27
updated: 2025-12-27
tags:
  - Concepts
  - Architecture
---

# Concepts

## Codec vs Serializer

**Codec** is a simple interface for marshaling and unmarshaling:

```go
type Codec interface {
    ContentType() string
    Marshal(v any) ([]byte, error)
    Unmarshal(data []byte, v any) error
}
```

Use a codec directly when you need basic encoding without sanitization.

**Serializer[T]** wraps a codec with type-safe sanitization:

```go
type Serializer[T Cloner[T]] struct {
    // ...
}

func (s *Serializer[T]) Marshal(obj *T) ([]byte, error)
func (s *Serializer[T]) Unmarshal(data []byte) (*T, error)
```

Use a serializer when you need automatic field sanitization.

## Cloner[T] Constraint

All types used with `Serializer[T]` must implement `Cloner[T]`:

```go
type Cloner[T any] interface {
    Clone() T
}
```

This ensures the original value is never modified during sanitization.

For value types with no pointers, slices, or maps:

```go
func (u User) Clone() User { return u }
```

For types with reference fields:

```go
func (u User) Clone() User {
    clone := u
    if u.Tags != nil {
        clone.Tags = make([]string, len(u.Tags))
        copy(clone.Tags, u.Tags)
    }
    return clone
}
```

## Sanitization Tags

Struct tags declare how fields are sanitized:

| Tag | Behavior | Reversible |
|-----|----------|------------|
| `encrypt` | Symmetric or asymmetric encryption | Yes |
| `hash` | One-way cryptographic hash | No |
| `redact` | Full replacement with mask string | No |
| `mask` | Content-aware partial masking | No |

### Tag Precedence

When multiple tags are present, the first matching tag wins:

1. `encrypt` - Reversible, takes priority
2. `hash` - One-way transformation
3. `redact` - Destructive replacement
4. `mask` - Partial masking

```go
// encrypt wins
Field string `encrypt:"pii" hash:"sha256"`
```

### Tag Values

Tag values reference registered components:

```go
// Tag value "pii" maps to registered encryptor
Password string `encrypt:"pii"`

// Registration
codec.WithEncryptor("pii", enc)
```

Built-in mask types don't require registration:

```go
// "email" is a built-in mask type
Email string `mask:"email"`
```

## Sentinel Integration

The serializer uses [sentinel](https://github.com/zoobzio/sentinel) for struct tag inspection. On creation, it scans the type once and caches metadata:

```go
// Type is scanned once
ser, _ := codec.NewSerializer[User](json.New(), opts...)

// Cached metadata used for all operations
ser.Marshal(&user1)
ser.Marshal(&user2)
```

This avoids repeated reflection on every marshal/unmarshal.

## Registry Caching

For frequently-used serializers, the registry provides thread-safe caching:

```go
// First call creates and caches
ser1, _ := codec.Use[User](json.New(), opts...)

// Subsequent calls return cached instance
ser2, _ := codec.Use[User](json.New(), opts...)

// ser1 == ser2 (same instance)
```

## Escape Hatches

For performance-critical paths, implement these interfaces to bypass reflection:

```go
type Sanitizable interface {
    Sanitize() error
}

type Desanitizable interface {
    Desanitize() error
}
```

When implemented, the serializer calls these methods instead of using reflection:

```go
func (u *User) Sanitize() error {
    u.Password = customEncrypt(u.Password)
    u.Email = customMask(u.Email)
    return nil
}

func (u *User) Desanitize() error {
    u.Password = customDecrypt(u.Password)
    return nil
}
```

See [Escape Hatches](../4.cookbook/1.escape-hatches.md) for implementation guidance.
